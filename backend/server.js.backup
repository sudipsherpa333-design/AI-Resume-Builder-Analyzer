// backend/src/server.js
import mongoose from 'mongoose';
import app from './app.js';

// Load environment variables
import dotenv from 'dotenv';
dotenv.config();

// Connect to MongoDB
const connectDB = async () => {
    try {
        console.log('üîó Connecting to MongoDB Atlas...');

        await mongoose.connect(process.env.MONGODB_URI, {
            useNewUrlParser: true,
            useUnifiedTopology: true,
        });

        console.log(`‚úÖ MongoDB Atlas Connected!`);
        console.log(`üìä Database: ${mongoose.connection.name}`);
        console.log(`üìç Host: ${mongoose.connection.host}`);

        return true;
    } catch (error) {
        console.error('‚ùå MongoDB Connection Error:', error.message);
        console.log('\nüîß Troubleshooting MongoDB Atlas:');
        console.log('1. Check if your IP is whitelisted in MongoDB Atlas');
        console.log('2. Check network connection');
        console.log('3. Verify MongoDB URI in .env file');

        // Continue without MongoDB for demo
        console.log('\n‚ö†Ô∏è  Starting server in DEMO MODE (without database)');
        return false;
    }
};

// Start server
const startServer = async () => {
    try {
        console.log('\n' + '='.repeat(50));
        console.log('üîç Starting AI Resume Builder Server...');
        console.log('='.repeat(50));

        // Try to connect to MongoDB
        const dbConnected = await connectDB();

        const PORT = process.env.PORT || 5001;

        const server = app.listen(PORT, '0.0.0.0', () => {
            console.log('\n' + '='.repeat(50));
            console.log('üöÄ AI RESUME BUILDER BACKEND');
            console.log('='.repeat(50));
            console.log(`‚úÖ SERVER STATUS: RUNNING`);
            console.log(`üìç PORT: ${PORT}`);
            console.log(`üåê URL: http://localhost:${PORT}`);
            console.log(`üåê URL: http://127.0.0.1:${PORT}`);
            console.log(`üìä DATABASE: ${dbConnected ? 'Connected to Atlas' : 'Demo Mode'}`);
            console.log(`üåç ENVIRONMENT: ${process.env.NODE_ENV}`);
            console.log(`üîó FRONTEND: ${process.env.FRONTEND_URL}`);
            console.log('='.repeat(50));
            console.log('üìù By: Sudip Sherpa');
            console.log('üéì BCA 6th Semester Project');
            console.log('='.repeat(50));
            console.log('\nüì¢ OPEN YOUR BROWSER TO:');
            console.log(`üëâ http://localhost:${PORT}`);
            console.log(`üëâ http://localhost:${PORT}/api/health`);
            console.log('='.repeat(50) + '\n');
        });

        // Handle port in use
        server.on('error', (error) => {
            if (error.code === 'EADDRINUSE') {
                console.log(`‚ùå Port ${PORT} is busy. Trying port ${Number(PORT) + 1}...`);
                app.listen(Number(PORT) + 1, '0.0.0.0');
            } else {
                console.error('Server error:', error);
            }
        });

        return server;

    } catch (error) {
        console.error('‚ùå Failed to start server:', error);
        process.exit(1);
    }
};

// Start server if run directly
if (import.meta.url === `file://${process.argv[1]}`) {
    startServer();
}